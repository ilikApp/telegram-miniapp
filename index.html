<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>GlÃ¼cksrad</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>

<h1>ğŸ¡ GlÃ¼cksrad</h1>

<button id="addPointsBtn">+10 Punkte</button>
<p id="username"></p>
<p id="points"></p>

<button id="spin">Rad drehen</button>

<div id="betBox" style="display:none;">
  <p>Wie viele Punkte setzt du?</p>
  <input id="betInput" type="number" min="1">
  <button onclick="startRisk()">Einsatz bestÃ¤tigen</button>
</div>

<h2 id="question" style="display:none;"></h2>
<div id="answers" style="display:none;"></div>

<p id="result"></p>

<h2>ğŸ† Leaderboard</h2>
<ul id="leaderboard"></ul>

<script>
const API = "https://gluecksrad-backend.onrender.com";

const tg = Telegram.WebApp;
tg.ready();

const user = tg.initDataUnsafe.user || { username: "Gast", id: "guest_" + Math.random().toString(36).slice(2) };
const USER_ID = "user_" + user.id;

let points = 0;
let currentQuestion = null;
let bet = 0;
let riskMode = false;

// ---------------- INIT ----------------
loadUser();
loadLeaderboard();

// ---------------- USER ----------------
function loadUser() {
  fetch(API + "/me/" + USER_ID)
    .then(r => r.json())
    .then(d => {
      points = d.points ?? 0;
      updateUI();
    });
}

function updateUI() {
  document.getElementById("username").innerText = "Benutzer: " + user.username;
  document.getElementById("points").innerText = "Punkte: " + points;
}

// ---------------- POINTS ----------------
document.getElementById("addPointsBtn").onclick = () => {
  points += 10;
  savePoints();
  document.getElementById("result").innerText = "â• 10 Punkte";
  updateUI();
};

// ---------------- SPIN ----------------
document.getElementById("spin").onclick = () => {
  resetUI();
  const r = Math.random();

  if (r < 0.4) {
    points += 10;
    document.getElementById("result").innerText = "â• 10 Punkte";
    updateUI();
    savePoints();
  } else if (r < 0.7) {
    fetchQuestion();
  } else {
    document.getElementById("betBox").style.display = "block";
    document.getElementById("result").innerText = "ğŸ² Risiko-Modus!";
  }
};

// ---------------- RISK ----------------
function startRisk() {
  bet = parseInt(document.getElementById("betInput").value);
  if (!bet || bet <= 0 || bet > points) {
    alert("UngÃ¼ltiger Einsatz");
    return;
  }
  riskMode = true;
  document.getElementById("betBox").style.display = "none";
  fetchQuestion();
}

// ---------------- QUESTIONS ----------------
function fetchQuestion() {
  fetch(API + "/question/random")
    .then(r => r.json())
    .then(q => {
      currentQuestion = q;
      showQuestion();
    });
}

function showQuestion() {
  const q = document.getElementById("question");
  const a = document.getElementById("answers");

  q.innerText = currentQuestion.question;
  q.style.display = "block";

  a.innerHTML = "";
  a.style.display = "block";

  currentQuestion.answers.forEach((text, i) => {
    const btn = document.createElement("button");
    btn.innerText = text;
    btn.onclick = () => answer(i);
    a.appendChild(btn);
  });
}

function answer(index) {
  if (!currentQuestion) return;

  if (index === currentQuestion.correct) {
    if (riskMode) {
      points += bet;
      document.getElementById("result").innerText = "ğŸ”¥ Richtig! Einsatz gewonnen";
    } else {
      points += currentQuestion.points;
      document.getElementById("result").innerText = "âœ… Richtig!";
    }
  } else {
    if (riskMode) {
      points -= bet;
      document.getElementById("result").innerText = "ğŸ’¥ Falsch! Einsatz verloren";
    } else {
      document.getElementById("result").innerText = "âŒ Falsch!";
    }
  }

savePoints().then(() => {
  updateUI();
  loadLeaderboard();
  resetState();
});
}

// ---------------- BACKEND ----------------
function savePoints() {
  return fetch(API + "/me/" + USER_ID, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      points,
      name: user.username
    })
  });
}


function loadLeaderboard() {
  fetch(API + "/leaderboard")
    .then(r => r.json())
    .then(data => {
      const list = document.getElementById("leaderboard");
      list.innerHTML = "";
      data.forEach((u, i) => {
        const li = document.createElement("li");
li.innerText = `${i + 1}. ${u.name} â€“ ${u.points}`;
        list.appendChild(li);
      });
    });
}

// ---------------- RESET ----------------
function resetUI() {
  document.getElementById("betBox").style.display = "none";
  document.getElementById("question").style.display = "none";
  document.getElementById("answers").style.display = "none";
}

function resetState() {
  currentQuestion = null;
  bet = 0;
  riskMode = false;
}
</script>
</body>
</html>
