<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Gl√ºcksrad</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <h1>üé° Gl√ºcksrad</h1>
  <button id="addPointsBtn">+10 Punkte</button>
  <p id="username"></p>
  <p id="points"></p>

  <button id="spin">Rad drehen</button>

  <div id="betBox" style="display:none;">
    <p>Wie viele Punkte setzt du?</p>
    <input id="betInput" type="number" min="1">
    <button onclick="startRisk()">Einsatz best√§tigen</button>
  </div>

  <h2 id="question" style="display:none;"></h2>
  <div id="answers" style="display:none;"></div>
  <p id="result"></p>
<h2>üèÜ Leaderboard</h2>
<ul id="leaderboard"></ul>

<script>
const tg = Telegram.WebApp;
const USER_ID = "user_" + (tg.initDataUnsafe.user?.id || Math.random().toString(36).slice(2));
tg.ready();

const user = tg.initDataUnsafe.user || { username: "Gast" };
let points = 0;
let currentQuestion = null;
let bet = 0;
let riskMode = false;

// Punkte laden
fetch("https://gluecksrad-backend.onrender.com/me/" + USER_ID)
  .then(res => res.json())
  .then(data => {
    points = data.points ?? 0;
    updateUI();
  });

function updateUI() {
  document.getElementById("username").innerText = "Benutzer: " + user.username;
  document.getElementById("points").innerText = "Punkte: " + points;
}

// +10 Punkte Button
document.getElementById("addPointsBtn").onclick = () => {
  points += 10;
  document.getElementById("result").innerText = "‚ûï 10 Punkte";
  updateUI();
  savePoints();
}

// Rad drehen
document.getElementById("spin").onclick = () => {
  resetUI();

  const r = Math.random();

  if (r < 0.4) {
    points += 10;
    document.getElementById("result").innerText = "‚ûï 10 Punkte";
    updateUI();
    savePoints();
  } else if (r < 0.7) {
    fetchQuestion(false);
  } else {
    document.getElementById("betBox").style.display = "block";
    document.getElementById("result").innerText = "üé≤ Risiko-Modus!";
  }
}

// Risiko starten
function startRisk() {
  bet = parseInt(document.getElementById("betInput").value);
  if (!bet || bet <= 0 || bet > points) {
    alert("Ung√ºltiger Einsatz");
    return;
  }
  riskMode = true;
  document.getElementById("betBox").style.display = "none";
  fetchQuestion(true);
}

// Frage vom Backend holen
function fetchQuestion(isRisk) {
  fetch("https://gluecksrad-backend.onrender.com/question/random")
    .then(res => res.json())
    .then(q => {
      currentQuestion = q;
      showQuestion();
    });
}

// Frage anzeigen
function showQuestion() {
  const qEl = document.getElementById("question");
  const aEl = document.getElementById("answers");

  qEl.innerText = currentQuestion.question;
  qEl.style.display = "block";

  aEl.innerHTML = "";
  aEl.style.display = "block";

  currentQuestion.answers.forEach((text, i) => {
    const btn = document.createElement("button");
    btn.innerText = text;
    btn.onclick = () => answer(i);
    aEl.appendChild(btn);
  });
}

// Antwort pr√ºfen
function answer(index) {
  if (!currentQuestion) return;

  if (index === currentQuestion.correct) {
    if (riskMode) {
      points += bet;
      document.getElementById("result").innerText = "üî• Richtig! Einsatz gewonnen";
    } else {
      points += currentQuestion.points;
      document.getElementById("result").innerText = `‚úÖ Richtig! +${currentQuestion.points} Punkte`;
    }
  } else {
    if (riskMode) {
      points -= bet;
      document.getElementById("result").innerText = "üí• Falsch! Einsatz verloren";
    } else {
      document.getElementById("result").innerText = "‚ùå Falsch!";
    }
  }

  updateUI();
  savePoints();
  resetState();
}

// Punkte speichern
function savePoints() {
  fetch("https://gluecksrad-backend.onrender.com/me/" + USER_ID, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ points })
  });
}

// UI zur√ºcksetzen, ohne Ergebnis zu l√∂schen
function resetUI() {
  document.getElementById("betBox").style.display = "none";
  document.getElementById("question").style.display = "none";
  document.getElementById("answers").style.display = "none";
}

// State nach Antwort zur√ºcksetzen
function resetState() {
  currentQuestion = null;
  bet = 0;
  riskMode = false;
}

</script>
</body>
</html>
