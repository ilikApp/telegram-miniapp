<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>GlÃ¼cksrad</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
body {
  font-family: system-ui, Arial, sans-serif;
  background: #f6f7fb;
  padding: 16px;
}

button {
  padding: 10px 14px;
  margin: 6px 0;
  font-size: 16px;
  border: none;
  border-radius: 8px;
  background: #4f46e5;
  color: white;
  cursor: pointer;
}

button:hover {
  background: #4338ca;
}

#answers button {
  display: block;
  width: 100%;
}

#leaderboard {
  list-style: none;
  padding: 0;
}

#leaderboard li {
  background: white;
  margin-bottom: 6px;
  padding: 8px 12px;
  border-radius: 8px;
}

#result {
  font-weight: bold;
  margin-top: 10px;
}
.grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
  margin-top: 20px;
}

.tile {
  background: #4f46e5;
  color: white;
  padding: 20px;
  border-radius: 14px;
  text-align: center;
  font-size: 18px;
  cursor: pointer;
  user-select: none;
}

.tile:hover {
  background: #4338ca;
}

</style>

</head>
<body>

<!-- ===== STARTSEITE ===== -->
<div id="homeView">
  <h1>ğŸ® Spielzentrum</h1>

  <div class="grid">
    <div class="tile" onclick="openLeaderboard()">ğŸ† Leaderboard</div>
    <div class="tile" onclick="openDaily()">ğŸ¡ Tagesrad</div>
    <div class="tile" onclick="openEndless()">â™¾ï¸ Endlos</div>
    <div class="tile" onclick="openRisk()">ğŸ’£ Risiko</div>
    <div class="tile" onclick="openClicker()">ğŸ–± Clicker</div>
  </div>
</div>
<!-- ===== LEADERBOARD SEITE ===== -->
<div id="leaderboardView" style="display:none;">
  <button onclick="goHome()">â¬… ZurÃ¼ck</button>
  <h1>ğŸ† Leaderboard</h1>
  <ul id="leaderboardOnly"></ul>
</div>

<!-- ===== SPIELANSICHT (dein bisheriges Spiel) ===== -->
<div id="gameView" style="display:none">
<button id="backBtn" style="display:none;" onclick="goHome()">â¬… ZurÃ¼ck</button>

<h1>ğŸ¡ GlÃ¼cksrad</h1>

<button id="addPointsBtn">+10 Punkte</button>
<p id="username"></p>
<p id="points"></p>

<button id="spin">Rad drehen</button>

<div id="betBox" style="display:none;">
  <p>Wie viele Punkte setzt du?</p>
  <input id="betInput" type="number" min="1">
  <button onclick="startRisk()">Einsatz bestÃ¤tigen</button>
</div>

<h2 id="question" style="display:none;"></h2>
<div id="answers" style="display:none;"></div>

<p id="result"></p>


</div>

<script>
const API = "https://gluecksrad-backend.onrender.com";

const tg = Telegram.WebApp;
tg.ready();

const user = tg.initDataUnsafe.user || { username: "Gast", id: "guest_" + Math.random().toString(36).slice(2) };
const USER_ID = "user_" + user.id;

let points = 0;
let currentQuestion = null;
let bet = 0;
let riskMode = false;
let currentMode = null; // daily | endless | risk

// ---------- ENDLESS LOGIC ----------
const ENDLESS_RESET_DAYS = 5;

function endlessAnswered() {
  return JSON.parse(localStorage.getItem("endless_answered") || "[]");
}

function markEndlessAnswered(id) {
  const list = endlessAnswered();
  list.push(id);
  localStorage.setItem("endless_answered", JSON.stringify(list));
}

function resetEndlessIfNeeded() {
  const last = localStorage.getItem("endless_reset");
  const now = Date.now();

  if (!last || now - Number(last) > ENDLESS_RESET_DAYS * 24 * 60 * 60 * 1000) {
    localStorage.removeItem("endless_answered");
    localStorage.setItem("endless_reset", now);
  }
}

// ---------- DAILY LOGIC ----------
function todayKey() {
  const d = new Date();
  return d.getFullYear() + "-" + (d.getMonth()+1) + "-" + d.getDate();
}

function hasPlayedDaily() {
  return localStorage.getItem("daily_" + todayKey()) === "yes";
}

function markDailyPlayed() {
  localStorage.setItem("daily_" + todayKey(), "yes");
}

// ---------------- INIT ----------------
loadUser();
// loadLeaderboard(); // âŒ nicht beim Start

// ---------------- USER ----------------
function loadUser() {
  fetch(API + "/me/" + USER_ID)
    .then(r => r.json())
    .then(d => {
      points = d.points ?? 0;
      updateUI();
    });
}

function updateUI() {
  document.getElementById("username").innerText = "Benutzer: " + user.username;
  document.getElementById("points").innerText = "Punkte: " + points;
}

// ---------------- POINTS ----------------
document.getElementById("addPointsBtn").onclick = () => {
  points += 10;
  savePoints();
  document.getElementById("result").innerText = "â• 10 Punkte";
  updateUI();
};

// ---------------- SPIN ----------------
document.getElementById("spin").onclick = () => {
  resetUI();
  const r = Math.random();

  if (r < 0.4) {
    points += 10;
    document.getElementById("result").innerText = "â• 10 Punkte";
    updateUI();
    savePoints();
  } else if (r < 0.7) {
    fetchQuestion();
  } else {
    document.getElementById("betBox").style.display = "block";
    document.getElementById("result").innerText = "ğŸ² Risiko-Modus!";
  }
};

// ---------------- RISK ----------------
function startRisk() {
  bet = parseInt(document.getElementById("betInput").value);
  if (!bet || bet <= 0 || bet > points) {
    alert("UngÃ¼ltiger Einsatz");
    return;
  }
  riskMode = true;
  document.getElementById("betBox").style.display = "none";
  fetchQuestion();
}

// ---------------- QUESTIONS ----------------
function fetchQuestion() {
  fetch(API + "/question/random")
    .then(r => r.json())
    .then(q => {
      currentQuestion = q;
      showQuestion();
    });
}
function fetchEndlessQuestion() {
  fetch(API + "/question/random")
    .then(r => r.json())
    .then(q => {
      const answered = endlessAnswered();

      if (answered.includes(q.id)) {
        // nochmal versuchen
        fetchEndlessQuestion();
        return;
      }

      currentQuestion = q;
      showQuestion();
    })
   .catch(() => {
  document.getElementById("question").style.display = "none";
  document.getElementById("answers").style.display = "none";

  document.getElementById("result").innerText =
    "ğŸ˜´ Du hast alle verfÃ¼gbaren Fragen beantwortet.\nKomm spÃ¤ter wieder oder geh zurÃ¼ck â¬…";

});

}

function showQuestion() {
  const q = document.getElementById("question");
  const a = document.getElementById("answers");

  q.innerText = currentQuestion.question;
  q.style.display = "block";

  a.innerHTML = "";
  a.style.display = "block";

  currentQuestion.answers.forEach((text, i) => {
    const btn = document.createElement("button");
    btn.innerText = text;
    btn.onclick = () => answer(i);
    a.appendChild(btn);
  });
}

function answer(index) {
if (currentMode === "endless") {
  if (!currentQuestion) return;

  if (index === currentQuestion.correct) {
    points += 3;
    document.getElementById("result").innerText = "â™¾ï¸ Richtig! +3 Punkte";
  } else {
    document.getElementById("result").innerText = "âŒ Falsch!";
  }

  markEndlessAnswered(currentQuestion.id);

  savePoints().then(() => {
    updateUI();
    setTimeout(fetchEndlessQuestion, 800);
  });

  return; // â›” WICHTIG: stoppt Tagesrad & Risiko
}

 if (!currentQuestion) return;

if (index === currentQuestion.correct) {
if (currentMode === "endless") {
  if (index === currentQuestion.correct) {
    points += 3;
    document.getElementById("result").innerText = "â™¾ï¸ Richtig! +3 Punkte";
  } else {
    document.getElementById("result").innerText = "âŒ Falsch!";
  }

  markEndlessAnswered(currentQuestion.id);
  savePoints().then(() => {
    updateUI();
    setTimeout(fetchEndlessQuestion, 800);
  });

  return; // â›” GANZ WICHTIG: hier abbrechen
}

 if (currentMode === "daily") {
  points += 10;
  document.getElementById("result").innerText = "ğŸ¡ Tagesrad geschafft! +10 Punkte";
  markDailyPlayed();

  // âŒ Tagesrad darf NICHT nochmal benutzt werden
  document.getElementById("spin").disabled = true;
}

  else if (riskMode) {
    points += bet;
    document.getElementById("result").innerText = "ğŸ”¥ Richtig! Einsatz gewonnen";
  }

  else {
    points += currentQuestion.points;
    document.getElementById("result").innerText = "âœ… Richtig!";
  }
}
 else {
    if (riskMode) {
      points -= bet;
      document.getElementById("result").innerText = "ğŸ’¥ Falsch! Einsatz verloren";
    } else {
      document.getElementById("result").innerText = "âŒ Falsch!";
    }
  }

savePoints().then(() => {
  updateUI();
  loadLeaderboard();
  resetState();

  if (currentMode === "daily") {
    setTimeout(goHome, 1200);
  }
if (currentMode === "endless") {
  setTimeout(fetchEndlessQuestion, 800);
}
});
}

// ---------------- BACKEND ----------------
function savePoints() {
  return fetch(API + "/me/" + USER_ID, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    points,
    name: user.username
  })
})
.then(() => loadLeaderboard());
}


function loadLeaderboard() {
  fetch(API + "/leaderboard")
    .then(r => r.json())
    .then(data => {
      const list = document.getElementById("leaderboard");
      list.innerHTML = "";
     data.forEach((u, i) => {
  const li = document.createElement("li");

 let medal = "";
if (i === 0) medal = "ğŸ¥‡ ";
if (i === 1) medal = "ğŸ¥ˆ ";
if (i === 2) medal = "ğŸ¥‰ ";

if (u.id === USER_ID) {
  li.innerHTML = `${medal}â­ <b>${i + 1}. ${u.name} â€“ ${u.points}</b>`;
} else {
  li.innerText = `${medal}${i + 1}. ${u.name} â€“ ${u.points}`;
}


  list.appendChild(li);
});

    });
}

// ---------------- RESET ----------------
function resetUI() {
  document.getElementById("betBox").style.display = "none";
  document.getElementById("question").style.display = "none";
  document.getElementById("answers").style.display = "none";
}

function resetState() {
  currentQuestion = null;
  bet = 0;
  riskMode = false;
}
// ---------- NAVIGATION ----------
function hideAllViews() {
  document.getElementById("homeView").style.display = "none";
  document.getElementById("gameView").style.display = "none";
  document.getElementById("leaderboardView").style.display = "none";
}

function openLeaderboard() {
  hideAllViews();
  document.getElementById("leaderboardView").style.display = "block";
  loadLeaderboardOnly();
}

function openDaily() {
  if (hasPlayedDaily()) {
    alert("ğŸ¡ Du hast das Tagesrad heute schon gespielt!");
    goHome();
    return;
  }
document.getElementById("spin").style.display = "block";

  hideAllViews();
  document.getElementById("gameView").style.display = "block";

  currentMode = "daily";
  fetchQuestion();
}

function openEndless() {
  resetEndlessIfNeeded();

  hideAllViews();
  document.getElementById("gameView").style.display = "block";

  // âŒ NICHT erlaubte Sachen im Endlos
  document.getElementById("spin").style.display = "none";
  document.getElementById("betBox").style.display = "none";
  document.getElementById("addPointsBtn").style.display = "none";

  // âœ… ZurÃ¼ck-Button anzeigen
  document.getElementById("backBtn").style.display = "block";

  currentMode = "endless";
  document.getElementById("result").innerText = "";

  fetchEndlessQuestion();
}

function openRisk() {
  hideAllViews();
  document.getElementById("gameView").style.display = "block";
  document.getElementById("betBox").style.display = "block";
}

function openClicker() {
  alert("Clicker kommt im nÃ¤chsten Schritt ğŸ˜„");
}
function loadLeaderboardOnly() {
  fetch(API + "/leaderboard")
    .then(r => r.json())
    .then(data => {
      const list = document.getElementById("leaderboardOnly");
      list.innerHTML = "";

      data.forEach((u, i) => {
        const li = document.createElement("li");

        let medal = "";
        if (i === 0) medal = "ğŸ¥‡ ";
        if (i === 1) medal = "ğŸ¥ˆ ";
        if (i === 2) medal = "ğŸ¥‰ ";

        li.innerText = `${medal}${i + 1}. ${u.name} â€“ ${u.points}`;
        list.appendChild(li);
      });
    });
}
function goHome() {
  hideAllViews();

  // Alles zurÃ¼cksetzen
  document.getElementById("spin").style.display = "block";
  document.getElementById("addPointsBtn").style.display = "block";
  document.getElementById("backBtn").style.display = "none";
  document.getElementById("spin").disabled = false;

  document.getElementById("homeView").style.display = "block";
}

</script>
</body>
</html>
