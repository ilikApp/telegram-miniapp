<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>GlÃ¼cksrad</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
body {
  font-family: system-ui, Arial, sans-serif;
  background: #f6f7fb;
  padding: 16px;
}

button {
  padding: 10px 14px;
  margin: 6px 0;
  font-size: 16px;
  border: none;
  border-radius: 8px;
  background: #4f46e5;
  color: white;
  cursor: pointer;
}

button:hover {
  background: #4338ca;
}

#answers button {
  display: block;
  width: 100%;
}

#leaderboard {
  list-style: none;
  padding: 0;
}

#leaderboard li {
  background: white;
  margin-bottom: 6px;
  padding: 8px 12px;
  border-radius: 8px;
}

#result {
  font-weight: bold;
  margin-top: 10px;
}
.grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
  margin-top: 20px;
}

.tile {
  background: #4f46e5;
  color: white;
  padding: 20px;
  border-radius: 14px;
  text-align: center;
  font-size: 18px;
  cursor: pointer;
  user-select: none;
}

.tile:hover {
  background: #4338ca;
}

#clickerBtn {
  background: #dc2626;
  width: 200px;
  height: 200px;
  border-radius: 50%;
  font-size: 28px;
  margin-top: 30px;
}

#clickerBtn:hover {
  background: #b91c1c;
}
#clickerBtn {
  position: relative;
  overflow: hidden;
}

.ripple {
  position: absolute;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.5);
  transform: scale(0);
  animation: ripple 600ms linear;
  pointer-events: none;
}

@keyframes ripple {
  to {
    transform: scale(4);
    opacity: 0;
  }
}

</style>

</head>
<body>

<!-- ===== STARTSEITE ===== -->
<div id="homeView">
  <h1>ğŸ® Spielzentrum</h1>

  <div class="grid">
    <div class="tile" onclick="openLeaderboard()">ğŸ† Leaderboard</div>
    <div class="tile" onclick="openDaily()">ğŸ¡ Tagesrad</div>
    <div class="tile" onclick="openEndless()">â™¾ï¸ Endlos</div>
    <div class="tile" onclick="openRisk()">ğŸ’£ Risiko</div>
    <div class="tile" onclick="openClicker()">ğŸ–± Clicker</div>
  </div>
</div>
<!-- ===== LEADERBOARD SEITE ===== -->
<div id="leaderboardView" style="display:none;">
  <button onclick="goHome()">â¬… ZurÃ¼ck</button>
  <h1>ğŸ† Leaderboard</h1>
  <ul id="leaderboardOnly"></ul>
</div>

<!-- ===== SPIELANSICHT (dein bisheriges Spiel) ===== -->
<div id="gameView" style="display:none">
<button id="backBtn" style="display:none;" onclick="goHome()">â¬… ZurÃ¼ck</button>

<h1>ğŸ¡ GlÃ¼cksrad</h1>

<p id="username"></p>
<p id="points"></p>

<button id="spin">Rad drehen</button>

<div id="betBox" style="display:none;">
  <p>Wie viele Punkte setzt du?</p>
  <input id="betInput" type="number" min="1" max="100">
  <button onclick="startRisk()">Einsatz bestÃ¤tigen</button>
</div>

<h2 id="question" style="display:none;"></h2>
<div id="answers" style="display:none;"></div>

<p id="result"></p>


</div>

<!-- ===== CLICKER SEITE ===== -->
<div id="clickerView" style="display:none; text-align:center; margin-top:40px;">
  <button onclick="goHome()">â¬… ZurÃ¼ck</button>

  <h1>ğŸ–± Clicker</h1>
  <p id="clickerPoints">Punkte: 0</p>

  <button id="clickerBtn">ğŸ”´ KLICK</button>
</div>

<script>
const API = "https://gluecksrad-backend.onrender.com";

const tg = Telegram.WebApp;
tg.ready();

const user = tg.initDataUnsafe.user || { username: "Gast", id: "guest_" + Math.random().toString(36).slice(2) };
const USER_ID = "user_" + user.id;

let points = 0;
let currentQuestion = null;
let bet = 0;
let riskMode = false;
let currentMode = null; // daily | endless | risk

// ---------- ENDLESS LOGIC ----------
const ENDLESS_RESET_DAYS = 5;

function endlessAnswered() {
  return JSON.parse(localStorage.getItem("endless_answered") || "[]");
}

function markEndlessAnswered(id) {
  const list = endlessAnswered();
  if (!list.includes(id)) {
    list.push(id);
    localStorage.setItem("endless_answered", JSON.stringify(list));
  }
}

function resetEndlessIfNeeded() {
  const last = localStorage.getItem("endless_reset");
  const now = Date.now();

  if (!last || now - Number(last) > ENDLESS_RESET_DAYS * 24 * 60 * 60 * 1000) {
    localStorage.removeItem("endless_answered");
    localStorage.setItem("endless_reset", now);
  }
}

// ---------- DAILY LOGIC ----------
function todayKey() {
  const d = new Date();
  return d.getFullYear() + "-" + (d.getMonth()+1) + "-" + d.getDate();
}

function hasPlayedDaily() {
  return localStorage.getItem("daily_" + todayKey()) === "yes";
}

function markDailyPlayed() {
  localStorage.setItem("daily_" + todayKey(), "yes");
}

// ---------------- INIT ----------------
loadUser();
// loadLeaderboard(); // âŒ nicht beim Start

// ---------------- USER ----------------
function loadUser() {
  fetch(API + "/me/" + USER_ID)
    .then(r => r.json())
    .then(d => {
      points = d.points ?? 0;
      updateUI();
    });
}

function updateUI() {
  document.getElementById("username").innerText = "Benutzer: " + user.username;
  document.getElementById("points").innerText = "Punkte: " + points;
}


// ---------------- SPIN ----------------
document.getElementById("spin").onclick = () => {
  if (currentMode === "daily" || currentMode === "endless") {
    return; // âŒ dort nicht erlaubt
  }

  resetUI();
  const r = Math.random();

  if (r < 0.4) {
    points += 10;
    document.getElementById("result").innerText = "â• 10 Punkte";
    updateUI();
    savePoints();
  } else if (r < 0.7) {
    fetchQuestion();
  }
};

// ---------------- RISK ----------------
function startRisk() {
  bet = parseInt(document.getElementById("betInput").value);

  if (!bet || bet <= 0) {
    alert("UngÃ¼ltiger Einsatz");
    return;
  }

  if (bet > 100) {
    alert("ğŸ’£ Maximaler Einsatz sind 100 Punkte!");
    return;
  }

  if (bet > points) {
    alert("Du hast nicht genug Punkte!");
    return;
  }

  document.getElementById("betBox").style.display = "none";
  fetchQuestion();
}

// ---------------- QUESTIONS ----------------
function fetchQuestion() {
  fetch(API + "/question/random")
    .then(r => r.json())
    .then(q => {
      currentQuestion = q;
      showQuestion();
    });
}
function fetchEndlessQuestion() {
  fetch(API + "/question/random")
    .then(r => r.json())
    .then(q => {
      const answered = endlessAnswered();

      // âŒ Frage schon beantwortet â†’ ENDE
      if (answered.includes(q.id)) {
        document.getElementById("question").style.display = "none";
        document.getElementById("answers").style.display = "none";

        document.getElementById("result").innerText =
          "ğŸ˜´ Du hast alle verfÃ¼gbaren Fragen beantwortet.\n" +
          "Komm in ein paar Tagen wieder oder geh zurÃ¼ck â¬…";

        return;
      }

      currentQuestion = q;
      showQuestion();
    });
}

function showQuestion() {
  const q = document.getElementById("question");
  const a = document.getElementById("answers");

  q.innerText = currentQuestion.question;
  q.style.display = "block";

  a.innerHTML = "";
  a.style.display = "block";

  currentQuestion.answers.forEach((text, i) => {
    const btn = document.createElement("button");
    btn.innerText = text;
    btn.onclick = () => answer(i);
    a.appendChild(btn);
  });
}

function answer(index) {
  if (!currentQuestion) return;

  // ================= ENDLOS =================
  if (currentMode === "endless") {
    // Buttons sofort deaktivieren (kein Spam-Klicken)
    document.querySelectorAll("#answers button").forEach(b => b.disabled = true);

    if (index === currentQuestion.correct) {
      points += 3;
      document.getElementById("result").innerText = "â™¾ï¸ Richtig! +3 Punkte";
    } else {
      document.getElementById("result").innerText = "âŒ Falsch!";
    }

    markEndlessAnswered(currentQuestion.id);

    savePoints().then(() => {
      updateUI();
      setTimeout(fetchEndlessQuestion, 800);
    });

    return; // â›” GANZ WICHTIG
  }

  // ================= DAILY / NORMAL =================
  if (index === currentQuestion.correct) {

if (currentMode === "daily") {
  points += 10;
  document.getElementById("result").innerText =
    "ğŸ¡ Tagesrad geschafft! +10 Punkte\nâ¬… Geh selbst zurÃ¼ck";
  markDailyPlayed();

  // âŒ keine weitere Frage
  document.getElementById("answers").style.display = "none";
}

else if (currentMode === "risk") {
  if (index === currentQuestion.correct) {
    points += bet;
    document.getElementById("result").innerText =
      "ğŸ”¥ Richtig! +" + bet + " Punkte";
  } else {
    points -= bet;
    document.getElementById("result").innerText =
      "ğŸ’¥ Falsch! -" + bet + " Punkte";
  }

  markRiskPlayed();
  document.getElementById("answers").style.display = "none";
}

    else {
      points += currentQuestion.points;
      document.getElementById("result").innerText = "âœ… Richtig!";
    }

  } else {
    if (riskMode) {
      points -= bet;
      document.getElementById("result").innerText =
        "ğŸ’¥ Falsch! Einsatz verloren";
    } else {
      document.getElementById("result").innerText = "âŒ Falsch!";
    }
  }

  savePoints().then(() => {
    updateUI();
    resetState();

  });
}

// ---------- RISK DAILY LOGIC ----------
function riskKey() {
  const d = new Date();
  return "risk_" + d.getFullYear() + "-" + (d.getMonth()+1) + "-" + d.getDate();
}

function hasPlayedRisk() {
  return localStorage.getItem(riskKey()) === "yes";
}

function markRiskPlayed() {
  localStorage.setItem(riskKey(), "yes");
}

// ---------------- BACKEND ----------------
function savePoints() {
  return fetch(API + "/me/" + USER_ID, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    points,
    name: user.username
  })
})
.then(() => loadLeaderboard());
}


function loadLeaderboard() {
  fetch(API + "/leaderboard")
    .then(r => r.json())
    .then(data => {
      const list = document.getElementById("leaderboard");
      list.innerHTML = "";
     data.forEach((u, i) => {
  const li = document.createElement("li");

 let medal = "";
if (i === 0) medal = "ğŸ¥‡ ";
if (i === 1) medal = "ğŸ¥ˆ ";
if (i === 2) medal = "ğŸ¥‰ ";

if (u.name === user.username) {
  li.innerHTML = `${medal}â­ <b>${i + 1}. ${u.name} â€“ ${u.points}</b>`;
} else {
  li.innerText = `${medal}${i + 1}. ${u.name} â€“ ${u.points}`;
}


  list.appendChild(li);
});

    });
}

// ---------------- RESET ----------------
function resetUI() {
  document.getElementById("betBox").style.display = "none";
  document.getElementById("question").style.display = "none";
  document.getElementById("answers").style.display = "none";
}

function resetState() {
  currentQuestion = null;
  bet = 0;
  riskMode = false;
}
// ---------- NAVIGATION ----------
function hideAllViews() {
  document.getElementById("homeView").style.display = "none";
  document.getElementById("gameView").style.display = "none";
  document.getElementById("leaderboardView").style.display = "none";
}

function openLeaderboard() {
  hideAllViews();
  document.getElementById("leaderboardView").style.display = "block";
  loadLeaderboardOnly();
}

function openDaily() {
  if (hasPlayedDaily()) {
    alert("ğŸ¡ Du hast das Tagesrad heute schon gespielt!");
    return;
  }

  hideAllViews();
  document.getElementById("gameView").style.display = "block";

  // âŒ alles verbieten
  document.getElementById("spin").style.display = "none";
  document.getElementById("betBox").style.display = "none";

  // âœ… ZurÃ¼ck-Button anzeigen
  document.getElementById("backBtn").style.display = "block";

  currentMode = "daily";
  document.getElementById("result").innerText = "";

  fetchQuestion(); // ğŸ¯ NUR FRAGE
}


function openEndless() {
  resetEndlessIfNeeded();

  hideAllViews();
  document.getElementById("gameView").style.display = "block";

  // âŒ NICHT erlaubte Sachen im Endlos
  document.getElementById("spin").style.display = "none";
  document.getElementById("betBox").style.display = "none";

  // âœ… ZurÃ¼ck-Button anzeigen
  document.getElementById("backBtn").style.display = "block";

  currentMode = "endless";
  document.getElementById("result").innerText = "";

  fetchEndlessQuestion();
}

function openRisk() {
  if (hasPlayedRisk()) {
    alert("ğŸ’£ Risiko hast du heute schon gespielt!");
    return;
  }

  hideAllViews();
  document.getElementById("gameView").style.display = "block";

  // âŒ alles andere AUS
  document.getElementById("spin").style.display = "none";
  document.getElementById("answers").style.display = "none";
  document.getElementById("question").style.display = "none";

  // âœ… Einsatz anzeigen
  document.getElementById("betBox").style.display = "block";

  // âœ… ZurÃ¼ck-Button
  document.getElementById("backBtn").style.display = "block";

  currentMode = "risk";
  riskMode = true;

  document.getElementById("result").innerText =
    "ğŸ’£ Setze Punkte und beantworte eine Frage!";
}

function openClicker() {
  hideAllViews();
  document.getElementById("clickerView").style.display = "block";

  document.getElementById("clickerPoints").innerText =
    "Punkte: " + points;
}
function loadLeaderboardOnly() {
  fetch(API + "/leaderboard")
    .then(r => r.json())
    .then(data => {
      const list = document.getElementById("leaderboardOnly");
      list.innerHTML = "";

      data.forEach((u, i) => {
        const li = document.createElement("li");

        let medal = "";
        if (i === 0) medal = "ğŸ¥‡ ";
        if (i === 1) medal = "ğŸ¥ˆ ";
        if (i === 2) medal = "ğŸ¥‰ ";

        li.innerText = `${medal}${i + 1}. ${u.name} â€“ ${u.points}`;
        list.appendChild(li);
      });
    });
}
function goHome() {
  // Zustand komplett zurÃ¼cksetzen
  currentMode = null;
  riskMode = false;
  currentQuestion = null;
  bet = 0;

  // Views verstecken
  document.getElementById("homeView").style.display = "none";
  document.getElementById("gameView").style.display = "none";
  document.getElementById("leaderboardView").style.display = "none";

  // Game-UI reset
  document.getElementById("spin").style.display = "block";
  document.getElementById("spin").disabled = false;
  document.getElementById("betBox").style.display = "none";
  document.getElementById("backBtn").style.display = "none";
  document.getElementById("question").style.display = "none";
  document.getElementById("answers").style.display = "none";
  document.getElementById("result").innerText = "";
document.getElementById("clickerView").style.display = "none";

  // Startseite zeigen
  document.getElementById("homeView").style.display = "block";
}
document.getElementById("clickerBtn").onclick = (e) => {
  const btn = e.currentTarget;

  // ğŸŒŠ Ripple erzeugen
  const ripple = document.createElement("span");
  ripple.className = "ripple";

  const rect = btn.getBoundingClientRect();
  const size = Math.max(rect.width, rect.height);

  ripple.style.width = ripple.style.height = size + "px";
  ripple.style.left = e.clientX - rect.left - size / 2 + "px";
  ripple.style.top = e.clientY - rect.top - size / 2 + "px";

  btn.appendChild(ripple);

  setTimeout(() => ripple.remove(), 600);

  // â• Punkte
points += 0.1;
points = Math.round(points * 100) / 100;  // Punkte auf 2 Dezimalstellen runden
document.getElementById("clickerPoints").innerText = "Punkte: " + points.toFixed(1);  // Anzeige aktualisieren

  updateUI();
  savePoints();
};

</script>
</body>
</html>
